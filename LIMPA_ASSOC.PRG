

CLOSE DATABASES all
CLOSE TABLES all
SET EXCLUSIVE OFF
SET DATE BRITISH

cDir = 'c:\desenv\win\vfp9\sca_new'
CD (cDir)

USE (cDir+'\CONTRATO' ) IN 0
USE (cDir+'\ASSOCIADO' ) IN 0
USE (cDir+'\ASSOCIADO_PLANO' ) IN 0
USE (cDir+'\ASSOCIADO_PSAUDE' ) IN 0
USE (cDir+'\ASSOCIADO_ACLINICO' ) IN 0
USE (cDir+'\ASSOCIADO_HOSPITAL' ) IN 0

SELECT CONTRATO
SET ORDER TO I_D   && IDCONTRATO

SELECT ASSOCIADO
SET ORDER TO IDASSOC

SELECT ASSOCIADO_PLANO
SET ORDER TO IDASSOC


SELECT ASSOCIADO_PSAUDE
SELECT ASSOCIADO_ACLINICO
SELECT ASSOCIADO_HOSPITAL



SELECT CONTRATO
SCAN FOR !EMPTY(datacancela)  AND (DATE()-datacancela) >= 365

   nIdCtr = CONTRATO.idContrato
   
   SELECT ASSOCIADO
   SET ORDER TO IDCONTRATO
   
   IF SEEK( nIdCtr, 'ASSOCIADO', 'IDCONTRATO' )

      SCAN FOR idContrato=nIdCtr
         nidA = ASSOCIADO.idAssoc
         

         SELECT ASSOCIADO_PSAUDE
         DELETE FOR idAssoc=nIdA
         SELECT ASSOCIADO_ACLINICO
         DELETE FOR idAssoc=nIdA
         SELECT ASSOCIADO_HOSPITAL
         DELETE FOR idAssoc=nIdA

         SELECT ASSOCIADO_PLANO
         SET ORDER TO IDASSOC
         IF SEEK( nIdA, 'ASSOCIADO_PLANO', 'IDASSOC' )
            SCAN WHILE idAssoc=nIdA
               DELETE 
            ENDSCAN 
         ENDIF 
         SELECT ASSOCIADO
         DELETE 

      ENDSCAN 
      
   ENDIF 
   
   SELECT CONTRATO
ENDSCAN 




